!function(){for(var t=0,i=["ms","moz","webkit","o"],e=0;e<i.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[i[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[i[e]+"CancelAnimationFrame"]||window[i[e]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(i){var e=(new Date).getTime(),o=Math.max(0,16-(e-t)),n=window.setTimeout(function(){i(e+o)},o);return t=e+o,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}();var Query=function(){};Query.prototype.getQueryStringByName=function(t){var i=location.search.match(new RegExp("[?&]"+t+"=([^&]+)","i"));return null===i||i.length<1?"":i[1]};var Block=function(t,i,e,o,n,r,s){this.size=t,this.row=i,this.col=e,this.color=o,this.type=s,this.x=n||0,this.y=r||0},Input=function(t,i,e,o,n,r){this.events={},this.element=t,this.saveElement=n,this.generateElement=r,this.size=i,this.row=e,this.col=o,this.isMobile=this.ifMobile(),this.touch=this.isMobile?"touchstart":"click",this.listening=!0,this.element.addEventListener(this.touch,this.message.bind(this),!1),this.saveElement.addEventListener(this.touch,this.save.bind(this),!1),this.generateElement.addEventListener(this.touch,this.generate.bind(this),!1)};Input.prototype.ifMobile=function(){var t=!1;return function(i){(/(android|ipad|playbook|silk|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(i)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(i.substr(0,4)))&&(t=!0)}(navigator.userAgent||navigator.vendor||window.opera),t},Input.prototype.listen=function(){this.listening=!0},Input.prototype.stopListen=function(){this.listening=!1},Input.prototype.getPosition=function(t,i){var e=this.size*this.col/this.element.getBoundingClientRect().width*t,o=this.size*this.row/this.element.getBoundingClientRect().height*i,n=Math.floor(o/this.size),r=Math.floor(e/this.size);return{row:n,col:r}},Input.prototype.message=function(t){if(this.listening){t.stopPropagation();var i=this.isMobile?t.touches:[t],e=i[0],o=e.offsetX||e.pageX-e.target.offsetLeft,n=e.offsetY||e.pageY-e.target.offsetTop,r=this.getPosition(o,n);this.fire("poke",r)}},Input.prototype.save=function(t){this.listening&&(t.stopPropagation(),this.fire("save"))},Input.prototype.generate=function(t){this.listening&&(t.stopPropagation(),this.fire("generate"))},Input.prototype.on=function(t,i){this.events[t]||(this.events[t]=[]),this.events[t].push(i)},Input.prototype.fire=function(t,i){var e=this.events[t];e&&e.forEach(function(t){t(i)})},Input.prototype.off=function(t){this.events[t]=null};var Output=function(t,i,e,o,n,r,s){this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.canvas.width=i*o,this.canvas.height=i*n,this.gridsize=i,this.blockSize=e,this.background=r,this.animationTime=s};Output.prototype.drawBackground=function(){this.ctx.fillStyle=this.background,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)},Output.prototype.drawBlock=function(t){if(t.color){var i=(t.col+.5)*this.gridsize,e=(t.row+.5)*this.gridsize,o=i-t.size/2+t.x,n=e-t.size/2+t.y,r=t.size;this.ctx.fillStyle=t.color,this.ctx.fillRect(o,n,r,r)}},Output.prototype.destroy=function(t,i){var e=this,o=(new Date).getTime(),n=o,r=e.blockSize-e.blockSize/e.animationTime*(o-n),s=0,a=function(){o=(new Date).getTime(),r=e.blockSize-e.blockSize/e.animationTime*(o-n);for(var c=0;c<t.length;c++){var h=t[c];h.size=r;var l=new Block(e.gridsize,h.row,h.col,e.background);e.drawBlock(l),e.drawBlock(h)}if(o-n>e.animationTime){cancelAnimationFrame(s);for(var u=0;u<t.length;u++)t[u].size=e.blockSize;return i()}s=requestAnimationFrame(a)};a()},Output.prototype.moveDown=function(t,i){var e=this,o=0,n=(new Date).getTime(),r=n,s=function(){n=(new Date).getTime();for(var a=0;a<t.length;a++){var c=t[a],h=c.block,l=h.col,u=h.row,d=c.to,p=new Block(e.gridsize,u,l,e.background,0,h.y);e.drawBlock(p),h.y=(d-u)*e.gridsize/e.animationTime*(n-r),e.drawBlock(h)}if(n-r>e.animationTime){cancelAnimationFrame(o);for(var m=0;m<t.length;m++)t[m].block.y=0;return i()}o=requestAnimationFrame(s)};s()},Output.prototype.moveLeft=function(t,i){if(0===t.length)return i();var e=this,o=0,n=(new Date).getTime(),r=n,s=function(){n=(new Date).getTime();for(var a=0;a<t.length;a++){var c=t[a],h=c.block,l=h.row,u=h.col,d=c.to,p=new Block(e.gridsize,l,u,e.background,h.x,0);e.drawBlock(p),h.x=(d-u)*e.gridsize/e.animationTime*(n-r),e.drawBlock(h)}if(n-r>e.animationTime){cancelAnimationFrame(o);for(var m=0;m<t.length;m++)t[m].block.x=0;return i()}o=requestAnimationFrame(s)};s()};var Score=function(t,i,e,o,n){this.nowContainer=t,this.bestContainer=i,this.remainingContainer=e,this.initLocalStorage(),this.key="bestScore",this.storage=window.localStorage?window.localStorage:window.fakeStorage,this.totalBlocks=o*n,this.score=0,this.remaining=this.totalBlocks,this.bestScore=this.getBestScore(),this.setScore()};Score.prototype.initLocalStorage=function(){window.fakeStorage={_data:{},setItem:function(t,i){return this._data[t]=String(i)},getItem:function(t){return this._data.hasOwnProperty(t)?this._data[t]:void 0}}},Score.prototype.getBestScore=function(){return this.storage.getItem(this.key)||0},Score.prototype.setHighScore=function(){var t=Math.max(this.bestScore,this.score);this.bestScore=t,this.storage.setItem(this.key,t)},Score.prototype.addScore=function(t){this.score+=t*t,this.remaining-=t,this.setScore()},Score.prototype.setScore=function(){this.setHighScore(),this.nowContainer.innerHTML=this.score,this.bestContainer.innerHTML=this.bestScore,this.remainingContainer.innerHTML=this.remaining},Score.prototype.reset=function(){this.score=0,this.remaining=this.totalBlocks,this.setScore()};var Alert=function(t,i){this.events={},this.alertContainer=t,this.alertContainer.addEventListener(i,this.message.bind(this),!1)};Alert.prototype.on=function(t,i){this.events[t]||(this.events[t]=[]),this.events[t].push(i)},Alert.prototype.fire=function(t,i){var e=this.events[t];e&&e.forEach(function(t){t(i)})},Alert.prototype.off=function(t){this.events[t]=null},Alert.prototype.show=function(){this.alertContainer.classList.remove("hide")},Alert.prototype.hide=function(){this.alertContainer.classList.add("hide")},Alert.prototype.message=function(t){t.stopPropagation(),t.target.classList.contains("restart")&&(this.fire("restart"),this.hide())};var Share=function(){this.image="http://vivaxy.github.io/vivaxy.png",this.link=location.href,this.title=document.title,this.content=document.title,"undefined"==typeof WeixinJSBridge?document.addEventListener("WeixinJSBridgeReady",this.onBridgeReady.bind(this),!1):this.onBridgeReady()};Share.prototype.onBridgeReady=function(){var t=this;WeixinJSBridge.call("showOptionMenu"),WeixinJSBridge.on("menu:share:appmessage",function(){WeixinJSBridge.invoke("sendAppMessage",{img_url:t.image,link:t.link,desc:t.content,title:t.title},function(){})}),WeixinJSBridge.on("menu:share:timeline",function(){WeixinJSBridge.invoke("shareTimeline",{img_url:t.image,link:t.link,desc:t.content,title:t.title},function(){})})};var Base64=function(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i=function(t){t=t.replace(/\r\n/g,"\n");for(var i="",e=0;e<t.length;e++){var o=t.charCodeAt(e);128>o?i+=String.fromCharCode(o):o>127&&2048>o?(i+=String.fromCharCode(o>>6|192),i+=String.fromCharCode(63&o|128)):(i+=String.fromCharCode(o>>12|224),i+=String.fromCharCode(o>>6&63|128),i+=String.fromCharCode(63&o|128))}return i},e=function(t){for(var i="",e=0,o=0,n=0,r=0;e<t.length;)o=t.charCodeAt(e),128>o?(i+=String.fromCharCode(o),e++):o>191&&224>o?(n=t.charCodeAt(e+1),i+=String.fromCharCode((31&o)<<6|63&n),e+=2):(n=t.charCodeAt(e+1),r=t.charCodeAt(e+2),i+=String.fromCharCode((15&o)<<12|(63&n)<<6|63&r),e+=3);return i};this.encode=function(e){var o,n,r,s,a,c,h,l="",u=0;for(e=i(e);u<e.length;)o=e.charCodeAt(u++),n=e.charCodeAt(u++),r=e.charCodeAt(u++),s=o>>2,a=(3&o)<<4|n>>4,c=(15&n)<<2|r>>6,h=63&r,isNaN(n)?c=h=64:isNaN(r)&&(h=64),l=l+t.charAt(s)+t.charAt(a)+t.charAt(c)+t.charAt(h);return l},this.decode=function(i){var o,n,r,s,a,c,h,l="",u=0;for(i=i.replace(/[^A-Za-z0-9\+\/\=]/g,"");u<i.length;)s=t.indexOf(i.charAt(u++)),a=t.indexOf(i.charAt(u++)),c=t.indexOf(i.charAt(u++)),h=t.indexOf(i.charAt(u++)),o=s<<2|a>>4,n=(15&a)<<4|c>>2,r=(3&c)<<6|h,l+=String.fromCharCode(o),64!=c&&(l+=String.fromCharCode(n)),64!=h&&(l+=String.fromCharCode(r));return l=e(l)}},Eliminate=function(t,i){this.colorList=["#3498db","#2ecc71","#9b59b6","#f1c40f","#e74c3c"],this.gridRow=t,this.gridCol=i,this.blockSize=96,this.gridSize=100,this.animationTime=100,this.blocks=[],this.directions=[{row:-1,col:0},{row:1,col:0},{row:0,col:-1},{row:0,col:1}],this.same=[],this.canvas=document.querySelector("canvas"),this.backgroundColor="rgb(200,200,200)",this.output=new Output(this.canvas,this.gridSize,this.blockSize,this.gridCol,this.gridRow,this.backgroundColor,this.animationTime),this.input=new Input(this.canvas,this.gridSize,this.gridRow,this.gridCol,document.querySelector(".save"),document.querySelector(".generate")),this.score=new Score(document.querySelector(".now"),document.querySelector(".best"),document.querySelector(".remaining"),this.gridRow,this.gridCol),this.alert=new Alert(document.querySelector(".alert"),this.input.touch),this.share=new Share,this.query=new Query,this.base64=new Base64;try{this.grid=JSON.parse(this.base64.decode(this.query.getQueryStringByName("grid")))}catch(e){this.grid=null}this.input.on("poke",this.poke.bind(this)),this.alert.on("restart",this.reset.bind(this)),this.reset(),this.input.on("save",this.saveGrid.bind(this)),this.input.on("generate",this.generateGrid.bind(this))};Eliminate.prototype.reset=function(){this.score.reset(),this.share.title=document.title,this.grid?this.useGrid():this.newBlocks(),this.redraw(),this.input.listen()},Eliminate.prototype.newBlocks=function(){this.blocks=[];for(var t=0;t<this.gridRow;t++){for(var i=[],e=0;e<this.gridCol;e++){var o=Math.floor(Math.random()*this.colorList.length),n=new Block(this.blockSize,t,e,this.colorList[o],0,0,o);i.push(n)}this.blocks.push(i)}},Eliminate.prototype.redraw=function(){this.output.drawBackground();for(var t=0;t<this.blocks.length;t++)for(var i=0;i<this.blocks[t].length;i++)this.output.drawBlock(this.blocks[t][i])},Eliminate.prototype.poke=function(t){var i=this,e=t.row,o=t.col,n=i.blocks[e][o];if(n.color){var r=i.sameBlocks(n);r.length>1&&(i.input.stopListen(),i.score.addScore(r.length),i.share.title="#eliminate# I scored "+i.score.score+" with "+i.score.remaining+" blocks left!",i.output.destroy(r,function(){for(var t=0;t<r.length;t++){var e=r[t];i.destroy(e.row,e.col)}i.redraw();var o=i.getMoveDownList();i.output.moveDown(o,function(){i.pullDown(o),i.redraw();var t=i.getMoveLeftList();i.output.moveLeft(t,function(){i.pullLeft(t),i.redraw(),i.input.listen(),i.couldBeEliminated()||i.gameOver()})})})),i.same=[]}},Eliminate.prototype.destroy=function(t,i){this.blocks[t][i].color=null},Eliminate.prototype.sameBlocks=function(t){for(var i=t.row,e=t.col,o=0;o<this.directions.length;o++){var n=i+this.directions[o].row,r=e+this.directions[o].col;if(this.inside(n,r)){var s=this.blocks[n][r];t.color&&s&&t.color==s.color&&!this.inSameList(s)&&(this.same.push(s),this.sameBlocks(s))}}return this.same},Eliminate.prototype.inSameList=function(t){for(var i=0;i<this.same.length;i++)if(t.row==this.same[i].row&&t.col==this.same[i].col)return!0;return!1},Eliminate.prototype.inside=function(t,i){return t>=0&&i>=0&&t<this.gridRow&&i<this.gridCol},Eliminate.prototype.pullDown=function(t){for(var i=t.length-1;i>=0;i--){var e=t[i].block.col,o=t[i].block.row,n=t[i].to,r=this.blocks[o][e].color,s=this.blocks[n][e].color;this.blocks[n][e].color=r,this.blocks[o][e].color=s}},Eliminate.prototype.getMoveDownList=function(){for(var t=[],i=0;i<this.gridCol;i++){for(var e=[],o=0;o<this.gridRow;o++)null===this.blocks[o][i].color&&e.push(o);for(var n=0;n<this.gridRow;n++){for(var r=0,s=0;s<e.length;s++)e[s]>n&&r++;if(r>0&&null!==this.blocks[n][i].color&&!this.topAllBlankBlocks(n,i)){var a={block:this.blocks[n][i],to:n+r};t.push(a)}}}return t},Eliminate.prototype.pullLeft=function(t){for(var i=0;i<t.length;i++){var e=t[i].block.row,o=t[i].block.col,n=t[i].to,r=this.blocks[e][o].color,s=this.blocks[e][n].color;this.blocks[e][n].color=r,this.blocks[e][o].color=s}},Eliminate.prototype.getMoveLeftList=function(){for(var t=0,i=[],e=1;e<this.gridCol;e++)if(this.isBlankCol(e-1)||t>0){this.isBlankCol(e-1)&&t++;for(var o=0;o<this.gridRow;o++){var n=this.blocks[o][e];if(null!==n.color){var r={};r.block=n,r.to=e-t,i.push(r)}}}return i},Eliminate.prototype.topAllBlankBlocks=function(t,i){for(var e=0;t>=e;e++)if(null!==this.blocks[e][i].color)return!1;return!0},Eliminate.prototype.isBlankCol=function(t){for(var i=0;i<this.gridRow;i++)if(null!==this.blocks[i][t].color)return!1;return!0},Eliminate.prototype.couldBeEliminated=function(){for(var t=0;t<this.gridCol;t++)for(var i=0;i<this.gridRow;i++){var e=this.blocks[t][i];if(this.sameBlocks(e).length>1)return this.same=[],!0}return this.same=[],!1},Eliminate.prototype.gameOver=function(){this.input.stopListen(),this.alert.show()},Eliminate.prototype.saveGrid=function(){if(this.score.score>0)return this.grid?this.reset():void 0;for(var t=[],i=0;i<this.blocks.length;i++){for(var e=this.blocks[i],o=[],n=0;n<e.length;n++){var r=e[n],s=r.type;o.push(s)}t.push(o)}location.search="grid="+this.base64.encode(JSON.stringify(t))},Eliminate.prototype.useGrid=function(){for(var t=[],i=0;i<this.grid.length;i++){for(var e=this.grid[i],o=[],n=0;n<e.length;n++){var r=e[n],s=new Block(this.blockSize,i,n,this.colorList[r],0,0,r);o.push(s)}t.push(o)}this.blocks=t},Eliminate.prototype.generateGrid=function(){location.search=""},new Eliminate(10,10);